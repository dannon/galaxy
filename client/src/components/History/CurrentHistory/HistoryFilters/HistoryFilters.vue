<template>
    <div>
        <GInputGroup>
            <DebouncedInput v-slot="{ value, input }" v-model="localFilter">
                <GInput
                    size="sm"
                    :class="filterText && 'font-weight-bold'"
                    :value="value"
                    :placeholder="'search datasets' | localize"
                    data-description="filter text input"
                    @input="input"
                    @keyup.esc="updateFilter('')" />
            </DebouncedInput>
            <GInputGroupAppend>
                <b-button
                    v-b-tooltip.hover
                    aria-haspopup="true"
                    size="sm"
                    :pressed="showAdvanced"
                    :variant="showAdvanced ? 'info' : 'secondary'"
                    data-description="show advanced filter toggle"
                    title="Show Advanced Filter"
                    aria-label="Show advanced filter"
                    @click="onToggle">
                    <icon v-if="showAdvanced" fixed-width icon="angle-double-up" />
                    <icon v-else fixed-width icon="angle-double-down" />
                </b-button>
                <b-button
                    v-b-tooltip.hover
                    aria-haspopup="true"
                    size="sm"
                    title="Clear Filters (esc)"
                    aria-label="Clear filters"
                    data-description="clear filters"
                    @click="updateFilter('')">
                    <icon fixed-width icon="times" />
                </b-button>
            </GInputGroupAppend>
        </GInputGroup>
        <div
            v-if="showAdvanced"
            class="mt-2"
            description="advanced filters"
            @keyup.enter="onSearch"
            @keyup.esc="onToggle">
            <small>Filter by name:</small>
            <GInput v-model="filterSettings['name:']" size="sm" placeholder="any name" />
            <small class="mt-1">Filter by extension:</small>
            <GInput v-model="filterSettings['extension:']" size="sm" placeholder="any extension" />
            <small class="mt-1">Filter by tag:</small>
            <GInput v-model="filterSettings['tag:']" size="sm" placeholder="any tag" />
            <small class="mt-1">Filter by state:</small>
            <GInputGroup>
                <GInput
                    v-model="filterSettings['state:']"
                    v-b-tooltip.focus.v-danger="hasError('state:')"
                    :class="hasError('state:') && 'ui-input-error'"
                    size="sm"
                    placeholder="any state"
                    list="stateSelect" />
                <b-form-datalist id="stateSelect" :options="states"></b-form-datalist>
                <GInputGroupAppend>
                    <b-button title="States Help" size="sm" @click="showHelp = true">
                        <icon icon="question" />
                    </b-button>
                </GInputGroupAppend>
                <StatesInfo :show-help.sync="showHelp" :exclude-states="excludeStates" @set-filter="onOption" />
            </GInputGroup>
            <small>Filter by database:</small>
            <GInput v-model="filterSettings['genome_build:']" size="sm" placeholder="any database" />
            <small class="mt-1">Filter by related to item index:</small>
            <GInput
                v-model="filterSettings['related:']"
                v-b-tooltip.focus.v-danger="hasError('related:')"
                :class="hasError('related:') && 'ui-input-error'"
                size="sm"
                placeholder="index equals" />
            <small class="mt-1">Filter by item index:</small>
            <b-form-group class="m-0">
                <GInputGroup>
                    <GInput
                        v-model="filterSettings['hid>']"
                        v-b-tooltip.focus.v-danger="hasError('hid>')"
                        :class="hasError('hid>') && 'ui-input-error'"
                        size="sm"
                        placeholder="index greater" />
                    <GInput
                        v-model="filterSettings['hid<']"
                        v-b-tooltip.focus.v-danger="hasError('hid<')"
                        :class="hasError('hid<') && 'ui-input-error'"
                        size="sm"
                        placeholder="index lower" />
                </GInputGroup>
            </b-form-group>
            <small class="mt-1">Filter by creation time:</small>
            <b-form-group class="m-0">
                <GInputGroup>
                    <GInput
                        v-model="create_time_gt"
                        v-b-tooltip.focus.v-danger="hasError('create_time>')"
                        :class="hasError('create_time>') && 'ui-input-error'"
                        size="sm"
                        placeholder="created after" />
                    <GInputGroupAppend>
                        <b-form-datepicker v-model="create_time_gt" reset-button button-only size="sm" />
                    </GInputGroupAppend>
                    <GInput
                        v-model="create_time_lt"
                        v-b-tooltip.focus.v-danger="hasError('create_time<')"
                        :class="hasError('create_time<') && 'ui-input-error'"
                        size="sm"
                        placeholder="created before" />
                    <GInputGroupAppend>
                        <b-form-datepicker v-model="create_time_lt" reset-button button-only size="sm" />
                    </GInputGroupAppend>
                </GInputGroup>
            </b-form-group>
            <history-filters-default :settings="filterSettings" @change="onOption" />
            <div class="mt-3">
                <b-button class="mr-1" size="sm" variant="primary" description="apply filters" @click="onSearch">
                    <icon icon="search" />
                    <span>{{ "Search" | localize }}</span>
                </b-button>
                <b-button size="sm" @click="onToggle">
                    <icon icon="redo" />
                    <span>{{ "Cancel" | localize }}</span>
                </b-button>
            </div>
        </div>
    </div>
</template>

<script>
import GInput from "component-library/GInput";
import DebouncedInput from "components/DebouncedInput";
import { STATES } from "components/History/Content/model/states";
import StatesInfo from "components/History/Content/model/StatesInfo";
import { HistoryFilters } from "components/History/HistoryFilters";

import HistoryFiltersDefault from "./HistoryFiltersDefault";

import GInputGroup from "@/component-library/GInputGroup.vue";
import GInputGroupAppend from "@/component-library/GInputGroupAppend.vue";

export default {
    components: {
        GInputGroup,
        GInputGroupAppend,
        DebouncedInput,
        GInput,
        HistoryFiltersDefault,
        StatesInfo,
    },
    props: {
        filterText: { type: String, default: null },
        showAdvanced: { type: Boolean, default: false },
        searchError: { type: Object, default: null },
    },
    data() {
        return {
            create_time_gt: "",
            create_time_lt: "",
            excludeStates: ["empty", "failed", "upload"],
            showHelp: false,
        };
    },
    computed: {
        filterSettings() {
            return HistoryFilters.toAlias(HistoryFilters.getFiltersForText(this.filterText));
        },
        localFilter: {
            get() {
                return this.filterText;
            },
            set(newVal) {
                if (newVal !== this.filterText) {
                    this.updateFilter(newVal);
                }
            },
        },
        states() {
            return Object.keys(STATES).filter((state) => !this.excludeStates.includes(state));
        },
    },
    watch: {
        filterSettings() {
            this.create_time_gt = this.filterSettings["create_time>"];
            this.create_time_lt = this.filterSettings["create_time<"];
        },
        showAdvanced(newVal) {
            this.showHelp = !newVal ? false : this.showHelp;
        },
    },
    methods: {
        hasError(field) {
            if (this.searchError && this.searchError.filter == field) {
                return this.searchError.typeError || this.searchError.msg;
            }
            return "";
        },
        onOption(name, value) {
            this.filterSettings[name] = value;
        },
        onSearch() {
            this.onToggle();
            this.filterSettings["create_time>"] = this.create_time_gt;
            this.filterSettings["create_time<"] = this.create_time_lt;
            this.updateFilter(HistoryFilters.getFilterText(this.filterSettings));
        },
        onToggle() {
            this.$emit("update:show-advanced", !this.showAdvanced);
        },
        updateFilter(newFilterText) {
            this.$emit("update:filter-text", newFilterText);
        },
    },
};
</script>
